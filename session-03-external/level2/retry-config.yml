# [Session 03 - Level 2] Resilience4j Retry ì„¤ì • ì˜ˆì‹œ
#
# application.ymlì— ì¶”ê°€í•˜ì—¬ ì¬ì‹œë„ ë™ì‘ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# ì•„ë˜ ì„¤ì •ì„ ë³µì‚¬í•˜ì—¬ app/src/main/resources/application.ymlì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.

resilience4j:
  retry:
    instances:
      paymentService:
        # TODO: max-attemptsë¥¼ 3ì—ì„œ 5ë¡œ ë³€ê²½í•˜ì—¬ ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ëŠ˜ë ¤ë³´ì„¸ìš”
        max-attempts: 3  # ì¬ì‹œë„ íšŸìˆ˜ (ì²« ì‹œë„ í¬í•¨)

        # TODO: wait-durationì„ 1sì—ì„œ 500msë¡œ ë³€ê²½í•˜ì—¬ ì¬ì‹œë„ ê°„ê²©ì„ ì¤„ì—¬ë³´ì„¸ìš”
        wait-duration: 1s  # ì¬ì‹œë„ ê°„ê²© (ê³ ì •)

        # ì¬ì‹œë„í•  ì˜ˆì™¸ íƒ€ì…
        retry-exceptions:
          - org.springframework.web.client.ResourceAccessException
          - java.net.SocketTimeoutException

        # ì¬ì‹œë„í•˜ì§€ ì•Šì„ ì˜ˆì™¸ íƒ€ì…
        ignore-exceptions:
          - java.lang.IllegalArgumentException


# ============================================
# ğŸ’¡ ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤
# ============================================
#
# 1. ê¸°ë³¸ ì„¤ì • (max-attempts: 3, wait-duration: 1s)
#    - ì´ ëŒ€ê¸° ì‹œê°„: ìµœëŒ€ 2ì´ˆ (1ì´ˆ Ã— 2ë²ˆ ì¬ì‹œë„)
#    - ì„±ê³µë¥ : ì•½ 60%
#
# 2. ì¬ì‹œë„ íšŸìˆ˜ ì¦ê°€ (max-attempts: 5)
#    - ì´ ëŒ€ê¸° ì‹œê°„: ìµœëŒ€ 4ì´ˆ
#    - ì„±ê³µë¥ : ì•½ 80%
#    - íŠ¸ë ˆì´ë“œì˜¤í”„: ì„±ê³µë¥  â†‘, ì‘ë‹µ ì‹œê°„ â†‘
#
# 3. ì¬ì‹œë„ ê°„ê²© ê°ì†Œ (wait-duration: 500ms)
#    - ì´ ëŒ€ê¸° ì‹œê°„: ìµœëŒ€ 2ì´ˆ (0.5ì´ˆ Ã— 4ë²ˆ)
#    - ë” ë¹ ë¥´ê²Œ ì¬ì‹œë„ ì‹œë„
#    - ì£¼ì˜: ì™¸ë¶€ APIì— ë¶€í•˜ ì¦ê°€
#
# 4. ì§€ìˆ˜ ë°±ì˜¤í”„ ì ìš© (ì•„ë˜ ê³ ê¸‰ ì„¤ì • ì°¸ê³ )
#    - ì¬ì‹œë„ ê°„ê²©ì´ ì ì  ì¦ê°€ (1ì´ˆ -> 2ì´ˆ -> 4ì´ˆ)
#    - ì™¸ë¶€ ì‹œìŠ¤í…œ ë³µêµ¬ ì‹œê°„ í™•ë³´


# ============================================
# ê³ ê¸‰ ì„¤ì •: ì§€ìˆ˜ ë°±ì˜¤í”„ (Exponential Backoff)
# ============================================
#
# resilience4j:
#   retry:
#     instances:
#       paymentService:
#         max-attempts: 5
#         wait-duration: 1s
#         enable-exponential-backoff: true  # ì§€ìˆ˜ ë°±ì˜¤í”„ í™œì„±í™”
#         exponential-backoff-multiplier: 2  # 2ë°°ì”© ì¦ê°€
#         # 1ì´ˆ -> 2ì´ˆ -> 4ì´ˆ -> 8ì´ˆ


# ============================================
# ê³ ê¸‰ ì„¤ì •: ì¬ì‹œë„ ì¡°ê±´ ì»¤ìŠ¤í„°ë§ˆì´ì§•
# ============================================
#
# Java ì½”ë“œë¡œ ì¬ì‹œë„ ì¡°ê±´ì„ ì„¸ë°€í•˜ê²Œ ì œì–´:
#
# @Bean
# public RetryConfig retryConfig() {
#     return RetryConfig.custom()
#         .maxAttempts(3)
#         .waitDuration(Duration.ofSeconds(1))
#         .retryOnResult(response ->
#             ((ResponseEntity<?>) response).getStatusCode().is5xxServerError()
#         )
#         .retryExceptions(IOException.class, TimeoutException.class)
#         .ignoreExceptions(IllegalArgumentException.class)
#         .build();
# }


# ============================================
# ğŸ’¡ ì¬ì‹œë„ ì „ëµ ì„ íƒ ê°€ì´ë“œ
# ============================================
#
# ê³ ì • ê°„ê²© (Fixed):
#   - ì‚¬ìš©: ê°„ë‹¨í•œ ì¼ì‹œì  ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì§€ì—°)
#   - ì˜ˆ: wait-duration: 1s
#
# ì§€ìˆ˜ ë°±ì˜¤í”„ (Exponential):
#   - ì‚¬ìš©: ì™¸ë¶€ ì‹œìŠ¤í…œ ê³¼ë¶€í•˜ ì‹œ
#   - ì˜ˆ: 1s -> 2s -> 4s
#   - ì¥ì : ì™¸ë¶€ ì‹œìŠ¤í…œ ë³µêµ¬ ì‹œê°„ í™•ë³´
#
# ì§€í„° í¬í•¨ (Jitter):
#   - ì‚¬ìš©: ë‹¤ìˆ˜ì˜ í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì‹œ ì¬ì‹œë„ ì‹œ
#   - ì˜ˆ: 1s Â± ëœë¤(200ms)
#   - ì¥ì : ì¬ì‹œë„ ë¶„ì‚° (Thundering Herd ë°©ì§€)


# ============================================
# ğŸ’¡ í…ŒìŠ¤íŠ¸ ë°©ë²•
# ============================================
#
# 1. ì„¤ì • ë³€ê²½ í›„ ì•± ì¬ì‹œì‘:
#    docker compose up -d --build app
#
# 2. ê²°ì œ API í˜¸ì¶œ:
#    curl -X POST http://localhost:8080/api/payments \
#      -H "Content-Type: application/json" \
#      -d '{"amount": 25000, "orderId": 1}'
#
# 3. ë¡œê·¸ì—ì„œ ì¬ì‹œë„ í™•ì¸:
#    docker logs grit-app --tail 50 | grep -i retry
#
# 4. ì„±ê³µë¥  ì¸¡ì •:
#    for i in {1..20}; do
#      curl -X POST http://localhost:8080/api/payments \
#        -H "Content-Type: application/json" \
#        -d "{\"amount\": 25000, \"orderId\": $i}"
#    done | grep -c "success"
