# [Session 11 - Level 3] GitHub Actions CI/CD íŒŒì´í”„ë¼ì¸
#
# .github/workflows/ci.yml íŒŒì¼ë¡œ ì €ì¥í•˜ì„¸ìš”.

name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  # ============================================
  # Job 1: í…ŒìŠ¤íŠ¸
  # ============================================
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: JDK 17 ì„¤ì¹˜
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # TODO 1: Gradle ìºì‹± ì„¤ì •
      # - name: Gradle ìºì‹œ
      #   uses: actions/cache@v3
      #   with:
      #     path: |
      #       ~/.gradle/caches
      #       ~/.gradle/wrapper
      #     key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          cd app
          ./gradlew test

      # TODO 2: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
      # - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
      #   uses: codecov/codecov-action@v3

  # ============================================
  # Job 2: Docker ì´ë¯¸ì§€ ë¹Œë“œ (main ë¸Œëœì¹˜ë§Œ)
  # ============================================
  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      # TODO 3: Docker Buildx ì„¤ì • (ë©€í‹° í”Œë«í¼ ë¹Œë“œ)
      # - name: Docker Buildx ì„¤ì •
      #   uses: docker/setup-buildx-action@v2

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          cd app
          docker build -t backend-practice:${{ github.sha }} .
          docker tag backend-practice:${{ github.sha }} backend-practice:latest

      # TODO 4: Docker Hub ë¡œê·¸ì¸ ë° í‘¸ì‹œ
      # - name: Docker Hub ë¡œê·¸ì¸
      #   uses: docker/login-action@v2
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}
      #
      # - name: Docker ì´ë¯¸ì§€ í‘¸ì‹œ
      #   run: |
      #     docker push backend-practice:${{ github.sha }}
      #     docker push backend-practice:latest

  # ============================================
  # TODO 5: ë°°í¬ Job (ì„ íƒì‚¬í•­)
  # ============================================
  # deploy:
  #   runs-on: ubuntu-latest
  #   needs: build
  #   if: github.ref == 'refs/heads/main'
  #
  #   steps:
  #     - name: SSHë¡œ ì„œë²„ ì ‘ì† ë° ë°°í¬
  #       uses: appleboy/ssh-action@v0.1.7
  #       with:
  #         host: ${{ secrets.SERVER_HOST }}
  #         username: ${{ secrets.SERVER_USER }}
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         script: |
  #           docker pull backend-practice:latest
  #           docker compose up -d --build

# ============================================
# ğŸ’¡ GitHub Secrets ì„¤ì • (Repository Settings)
# ============================================
# DOCKER_USERNAME: Docker Hub ì‚¬ìš©ìëª…
# DOCKER_PASSWORD: Docker Hub ì•¡ì„¸ìŠ¤ í† í°
# SERVER_HOST: ë°°í¬ ì„œë²„ IP
# SERVER_USER: SSH ì‚¬ìš©ìëª…
# SSH_PRIVATE_KEY: SSH í”„ë¼ì´ë¹— í‚¤
