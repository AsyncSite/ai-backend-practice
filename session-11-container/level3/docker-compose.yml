# =============================================================================
# [Session 11 - Level 3] Docker Compose 멀티 서비스 구성
# =============================================================================
# 여러 서비스를 함께 실행하는 Docker Compose 파일을 직접 작성합니다.
#
# 학습 목표:
#   1. 서비스 간 의존성(depends_on)을 이해한다
#   2. 네트워크를 통한 서비스 간 통신을 구성한다
#   3. 볼륨으로 데이터 영속성을 관리한다
#   4. 환경 변수로 설정을 외부화한다
#   5. 헬스체크로 서비스 준비 상태를 확인한다
#
# 사용 방법:
#   docker compose -f docker-compose.yml up -d
# =============================================================================

services:

  # ===========================================================================
  # 데이터베이스: MySQL
  # ===========================================================================

  # TODO 1: MySQL 서비스를 구성하세요
  #
  # 설정 항목:
  #   - 이미지: mysql:8.0
  #   - 컨테이너 이름: study-mysql
  #   - 포트: 3306:3306
  #   - 환경 변수: root 비밀번호, 데이터베이스 이름, 문자셋
  #   - 볼륨: 데이터 영속성 (컨테이너 삭제해도 데이터 유지)
  #   - 헬스체크: mysqladmin ping
  #   - 네트워크: app-net
  #
  # 힌트:
  #   mysql:
  #     image: mysql:8.0
  #     container_name: study-mysql
  #     ports:
  #       - "3306:3306"
  #     environment:
  #       MYSQL_ROOT_PASSWORD: root1234
  #       MYSQL_DATABASE: backend_study
  #       MYSQL_CHARACTER_SET_SERVER: utf8mb4
  #       MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
  #     volumes:
  #       - mysql_data:/var/lib/mysql
  #     healthcheck:
  #       test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot1234"]
  #       interval: 10s
  #       timeout: 5s
  #       retries: 5
  #       start_period: 30s
  #     networks:
  #       - app-net


  # ===========================================================================
  # 캐시: Redis
  # ===========================================================================

  # TODO 2: Redis 서비스를 구성하세요
  #
  # 설정 항목:
  #   - 이미지: redis:7-alpine (경량 Alpine 기반)
  #   - 컨테이너 이름: study-redis
  #   - 포트: 6379:6379
  #   - 볼륨: 데이터 영속성
  #   - 헬스체크: redis-cli ping
  #   - 네트워크: app-net
  #
  # 힌트:
  #   redis:
  #     image: redis:7-alpine
  #     container_name: study-redis
  #     ports:
  #       - "6379:6379"
  #     volumes:
  #       - redis_data:/data
  #     healthcheck:
  #       test: ["CMD", "redis-cli", "ping"]
  #       interval: 10s
  #       timeout: 5s
  #       retries: 5
  #     networks:
  #       - app-net


  # ===========================================================================
  # 애플리케이션: Spring Boot
  # ===========================================================================

  # TODO 3: Spring Boot 앱 서비스를 구성하세요
  #
  # 핵심 포인트:
  #   - build: Dockerfile 경로 지정
  #   - depends_on: MySQL, Redis가 healthy일 때만 시작
  #   - environment: DB, Redis 연결 정보 (컨테이너 이름을 호스트로 사용!)
  #
  # 중요: Docker Compose 네트워크에서는 서비스 이름이 호스트명이 됩니다.
  #   - MySQL 주소: mysql:3306 (localhost가 아님!)
  #   - Redis 주소: redis:6379
  #
  # 힌트:
  #   app:
  #     build:
  #       context: ./app
  #       dockerfile: Dockerfile
  #     container_name: study-app
  #     ports:
  #       - "8080:8080"
  #     depends_on:
  #       mysql:
  #         condition: service_healthy
  #       redis:
  #         condition: service_healthy
  #     environment:
  #       SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/backend_study?useSSL=false&allowPublicKeyRetrieval=true
  #       SPRING_DATASOURCE_USERNAME: root
  #       SPRING_DATASOURCE_PASSWORD: root1234
  #       SPRING_DATA_REDIS_HOST: redis
  #       SPRING_DATA_REDIS_PORT: 6379
  #       SPRING_JPA_HIBERNATE_DDL_AUTO: validate
  #     networks:
  #       - app-net


# =============================================================================
# 볼륨 정의
# =============================================================================

# TODO 4: 영속 볼륨을 정의하세요
#
# 컨테이너가 삭제되어도 데이터는 유지됩니다.
# docker volume ls 로 볼륨 목록 확인 가능
#
# 힌트:
#   volumes:
#     mysql_data:
#       name: study-mysql-data
#     redis_data:
#       name: study-redis-data


# =============================================================================
# 네트워크 정의
# =============================================================================

# TODO 5: 커스텀 네트워크를 정의하세요
#
# 같은 네트워크에 속한 컨테이너끼리만 통신할 수 있습니다.
# bridge 드라이버: 단일 호스트 내 가상 네트워크
#
# 힌트:
#   networks:
#     app-net:
#       name: study-app-net
#       driver: bridge
