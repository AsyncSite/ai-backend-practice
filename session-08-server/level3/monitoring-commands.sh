#!/bin/bash
set -e

# =============================================================================
# [Session 08 - Level 3] 서버 모니터링 명령어 실습
# =============================================================================
# 서버 관리자가 알아야 할 핵심 모니터링 명령어를 실습합니다.
#
# 학습 목표:
#   1. CPU/메모리 사용량을 실시간으로 모니터링할 수 있다
#   2. 프로세스별 리소스 사용량을 분석할 수 있다
#   3. 디스크 I/O 병목을 식별할 수 있다
#   4. 네트워크 연결 상태를 확인할 수 있다
#
# 사용 방법:
#   각 섹션의 명령어를 하나씩 실행하고 출력을 분석하세요.
#   Docker 컨테이너 내부에서 실행: docker exec -it grit-app sh
#   또는 호스트에서 직접 실행
# =============================================================================

echo "====================================="
echo " 서버 모니터링 실습 시작"
echo "====================================="

# =============================================================================
# 섹션 1: CPU 및 메모리 모니터링
# =============================================================================

echo ""
echo "--- 1. CPU/메모리 현황 ---"

# TODO 1: 시스템 전체 메모리 사용량을 확인하세요
#
# free 명령어: 메모리 사용 현황을 보여줍니다
#   - total: 전체 메모리
#   - used: 사용 중인 메모리
#   - free: 사용 가능한 메모리
#   - buff/cache: 버퍼/캐시로 사용 중 (필요 시 해제 가능)
#   - available: 실제로 사용 가능한 메모리 (free + 해제 가능한 cache)
#
# 힌트: free -h (사람이 읽기 쉬운 형식으로 출력)
# 실행:
# free -h

# TODO 2: CPU 사용률과 로드 애버리지를 확인하세요
#
# uptime 명령어: 시스템 가동 시간과 로드 애버리지를 보여줍니다
#   - load average: 1분, 5분, 15분 평균 대기 프로세스 수
#   - 코어 수 이하면 정상 (예: 4코어 서버에서 4.0 이하)
#   - 코어 수 초과면 과부하 (CPU가 처리 못하고 대기 중)
#
# 힌트: uptime
# 실행:
# uptime

# TODO 3: 실시간 시스템 모니터링 (top 명령어)
#
# top 명령어: 프로세스별 CPU/메모리 사용량을 실시간으로 보여줍니다
#   - %CPU: CPU 사용률
#   - %MEM: 메모리 사용률
#   - RES: 실제 물리 메모리 사용량
#   - COMMAND: 프로세스 이름
#
# 배치 모드(-b)로 한 번만 출력하기:
# 힌트: top -b -n 1 | head -20
# 실행:
# top -b -n 1 | head -20


# =============================================================================
# 섹션 2: 프로세스 분석
# =============================================================================

echo ""
echo "--- 2. 프로세스 분석 ---"

# TODO 4: Java 프로세스(Spring Boot)를 찾으세요
#
# ps 명령어: 실행 중인 프로세스 목록을 보여줍니다
#   - aux: 모든 사용자의 모든 프로세스를 상세히 표시
#   - grep java: Java 프로세스만 필터링
#
# 힌트: ps aux | grep java
# 실행:
# ps aux | grep java

# TODO 5: 메모리를 많이 사용하는 프로세스 Top 10을 찾으세요
#
# ps 명령어로 메모리 사용량 기준 정렬:
#   - --sort=-%mem: 메모리 사용률 내림차순 정렬
#   - -eo: 출력할 컬럼 지정
#
# 힌트: ps -eo pid,ppid,%cpu,%mem,rss,command --sort=-%mem | head -11
# 실행:
# ps -eo pid,ppid,%cpu,%mem,rss,command --sort=-%mem | head -11

# TODO 6: 특정 포트를 사용하는 프로세스를 찾으세요
#
# Spring Boot 앱이 8080 포트를 사용하고 있는지 확인:
#   - lsof: 열린 파일/포트 정보
#   - ss: 소켓 통계 (netstat의 현대적 대체)
#
# 힌트 (Linux): ss -tlnp | grep 8080
# 힌트 (Mac):   lsof -i :8080
# 실행:
# ss -tlnp | grep 8080


# =============================================================================
# 섹션 3: 디스크 I/O 확인
# =============================================================================

echo ""
echo "--- 3. 디스크 I/O ---"

# TODO 7: 디스크 사용량을 확인하세요
#
# df 명령어: 파일시스템별 디스크 사용량
#   - -h: 사람이 읽기 쉬운 형식
#   - Use%: 사용률 (80% 이상이면 주의, 90% 이상이면 긴급)
#
# 힌트: df -h
# 실행:
# df -h

# TODO 8: 큰 파일/디렉토리를 찾으세요
#
# du 명령어: 디렉토리별 디스크 사용량
#   - 로그 파일이 디스크를 가득 채우는 경우가 많습니다
#
# 힌트: du -sh /var/log/* 2>/dev/null | sort -rh | head -10
# 실행:
# du -sh /var/log/* 2>/dev/null | sort -rh | head -10

# TODO 9: 디스크 I/O 통계를 확인하세요
#
# iostat 명령어: 디스크 읽기/쓰기 성능 (sysstat 패키지 필요)
#   - %util: 디스크 사용률 (100%에 가까우면 I/O 병목)
#   - await: 평균 I/O 대기 시간 (ms)
#
# 힌트: iostat -x 1 3 (1초 간격으로 3번 측정)
# 대안 (iostat 없을 때): cat /proc/diskstats
# 실행:
# iostat -x 1 3 2>/dev/null || echo "iostat 미설치 - apt install sysstat"


# =============================================================================
# 섹션 4: 네트워크 연결 확인
# =============================================================================

echo ""
echo "--- 4. 네트워크 연결 ---"

# TODO 10: 현재 네트워크 연결 상태를 확인하세요
#
# ss 명령어: 소켓 통계
#   - -s: 소켓 통계 요약 (연결 상태별 개수)
#   - ESTABLISHED: 활성 연결
#   - TIME-WAIT: 종료 대기 중인 연결 (너무 많으면 문제)
#   - CLOSE-WAIT: 상대방이 연결을 끊었는데 우리가 정리 안 한 것 (누수!)
#
# 힌트: ss -s
# 실행:
# ss -s

# TODO 11: ESTABLISHED 연결 목록을 확인하세요
#
# 현재 활성 TCP 연결을 보여줍니다.
# MySQL(3306), Redis(6379) 등 백엔드 서비스 연결을 확인할 수 있습니다.
#
# 힌트: ss -tn state established
# 실행:
# ss -tn state established

# TODO 12: Docker 컨테이너 리소스 사용량을 확인하세요
#
# docker stats: 각 컨테이너의 CPU, 메모리, 네트워크 I/O를 실시간으로 보여줍니다
#   - --no-stream: 한 번만 출력 (실시간 모드 끄기)
#
# 힌트: docker stats --no-stream
# 실행:
# docker stats --no-stream


# =============================================================================
# 섹션 5: 종합 진단 스크립트 (심화)
# =============================================================================

echo ""
echo "--- 5. 종합 진단 ---"

# TODO 13: 아래 함수를 완성하여 서버 건강 상태를 한눈에 확인하세요
#
# check_server_health() {
#     echo "=== 서버 건강 상태 진단 ==="
#     echo ""
#
#     # 1) 시스템 정보
#     echo "[시스템] $(uname -a)"
#     echo "[가동시간] $(uptime)"
#     echo ""
#
#     # 2) 메모리 (사용률 계산)
#     echo "[메모리]"
#     free -h
#     echo ""
#
#     # 3) 디스크 (사용률 80% 이상인 파티션 경고)
#     echo "[디스크 - 80% 이상 파티션]"
#     df -h | awk 'NR==1 || +$5 >= 80'
#     echo ""
#
#     # 4) CPU 상위 5개 프로세스
#     echo "[CPU 상위 5 프로세스]"
#     ps -eo pid,%cpu,%mem,command --sort=-%cpu | head -6
#     echo ""
#
#     # 5) 네트워크 연결 요약
#     echo "[네트워크 연결]"
#     ss -s
#     echo ""
#
#     # 6) Spring Boot 헬스체크
#     echo "[Spring Boot 상태]"
#     curl -s http://localhost:8080/actuator/health 2>/dev/null || echo "앱 서버 응답 없음"
#     echo ""
# }
#
# 실행: check_server_health

echo ""
echo "====================================="
echo " 모니터링 실습 완료"
echo "====================================="
